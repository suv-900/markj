<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .container {
            display: flex;
            justify-content: space-around;
        }
        .table {
            border: 1px solid #000;
            padding: 10px;
            margin: 10px;
        }
        .table h2 {
            text-align: center;
        }
        .table ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .table li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="table"> 
            <h2 id="friendsListHeader">Friends</h2>
            <ul id="friendsList">
            </ul>
        </div>
        <div id="friendRequestsList"  class="table">
            <h2 id="friendRequestsHeader">Friend Requests</h2>
            <ul id="friendRequestsList">
                
            </ul>
        </div>
    </div>
    
    <div>
        <a >accept</a>
        <a >deny</a>
    </div>

        <form id="addUserForm">
            <input id="sendFriendRequestInput" type="text" placeholder="add user" required/><br>
            <button type="button" onclick="sendFriendRequest()" >send</button>
        </form>
        <div id="outputDiv" ></div>
    </body>
    <script>
        //show friends and pending friend requests;
        //check for token validate token
        //get friends list
        //send friend requests 
        
        const token=localStorage.getItem("Token");
        const outputDiv=document.getElementById("outputDiv");
        
        if(token === null){
            outputDiv.innerHTML="Login required";
            const anchorElement=document.createElement("a");
            anchorElement.href="localhost:8080/users/login";
            anchorElement.text="login";
            outputDiv.appendChild(anchorElement);
        }
        
        function isEmpty(s){
            return s.length === 0 ? true:false;
        }
        async function checkToken(){
            if(token === null) return;
             
            const xhttp=new XMLHttpRequest();

            xhttp.onreadystatechange=()=>{
                if(xhttp.readyState === 4){
                    const status=xhttp.status;
                    if(status === 200){
                        return;
                    } 
                    if(status === 500){
                        outputDiv.innerHTML="Server Error 500";
                    }
                    if(status === 401){
                        const anchorElement=document.createElement("a");
                        anchorElement.href="localhost:8080/users/login";
                        anchorElement.text="login";
                        outputDiv.appendChild(anchorElement);
                        outputDiv.innerHTML="Login Required";
                    }else{
                        console.log("Unknown status "+status);
                    }
                }

            }
            xhttp.open("POST","http://localhost:8080/users/verifytoken",true);
            xhttp.setRequestHeader("Token",token);
            xhttp.send();
        }
        checkToken(); 
        
        let friendsList=[]
        const friendRequestsList=[]

        async function fetchFriendsList(){
            const xhttp=new XMLHttpRequest();

            xhttp.onreadystatechange=()=>{
                if(xhttp.readyState === 4){
                    const status=xhttp.status;
                    if(status === 200){
                        
                        const friendsListNode=document.getElementById("friendsList");
                        friendsList=JSON.parse(xhttp.response);
                        
                        if(friendsList.length === 0){
                            const e=document.getElementById("friendsListHeader");
                            e.innerText="Friends 0";
                            return;
                        }
                        for(let i=0;i<friendsList.length;i++){
                            //id,username,email,online
                            const friend=friendsList[i];

                            const friendDiv=document.createElement("div");
                            friendDiv.id=friend.userID;
                            
                            const username=document.createElement("a");
                            username.href=`http://localhost:8080/users/getuser/${friend.username}`;
                            username.text=friend.username;
                            friendDiv.appendChild(username);

                            const id=document.createElement("div");
                            id.innerText=friend.userID;
                            friendDiv.appendChild(id);
                            
                            const email=document.createElement("div");
                            email.innerText=friend.emailID;
                            friendDiv.appendChild(email);
                            
                            const online=document.createElement("div");
                            online.innerText=friend.online;
                            friendDiv.appendChild(online);
                            
                            const fList=document.createElement("li");
                            fList.appendChild(friendDiv);

                            friendsListNode.appendChild(fList);
                        } 
                    } 
                    else if(status === 500){
                        outputDiv.innerHTML="Server Error 500";
                    }
                    else if(status === 401){
                        const anchorElement=document.createElement("a");
                        anchorElement.href="localhost:8080/users/login";
                        anchorElement.text="login";
                        outputDiv.appendChild(anchorElement);
                        outputDiv.innerHTML="Login Required";
                    }else{
                        console.log("Unknown status "+status);
                    }

                }
            }
            xhttp.open("GET","http://localhost:8080/users/getFriends",true);
            xhttp.setRequestHeader("Token",token);
            xhttp.send();
        } 
        fetchFriendsList();

        async function fetchPendingFriendRequests(){
            const xhttp=new XMLHttpRequest();
            xhttp.onreadystatechange=()=>{
                if(xhttp.readyState === 4){
                    const status=xhttp.status;
                    if(status === 200){
                        
                        requestList=JSON.parse(xhttp.response);
                        
                        console.log(requestList);
                        
                        if(requestList.length === 0){
                            const e=document.getElementById("friendRequestsHeader");
                            e.innerText="Friend Requests 0";
                            return;
                        }
                        
                        const friendRequestsList=document.getElementById("friendRequestsList");
                       
                        for(let i=0;i<requestList.length;i++){
                            //id,username,email,online
                            const request=requestList[i];

                            const requestDiv=document.createElement("div");
                            
                            const requestText=document.createElement("div");
                            requestText.innerText=request.senderUsername+" "+request.createdAt;
                            requestDiv.appendChild(requestText);
                            
                            const acceptButton=document.createElement("button");
                            acceptButton.type="button";
                            acceptButton.innerText="accept";
                            // acceptButton.onclick=()=>{acceptFriendRequest()};
                            requestDiv.appendChild(acceptButton);

                            const denyRequestButton=document.createElement("button");
                            denyRequestButton.type="button";
                            denyRequestButton.innerText="deny";
                            // denyRequestButton.onclick=()=>{denyFriendRequest()};
                            requestDiv.appendChild(denyRequestButton);

                            friendRequestsList.appendChild(requestDiv);
                        } 
                    } 
                    else if(status === 500){
                        outputDiv.innerHTML="Server Error 500";
                    }
                    else if(status === 401){
                        const anchorElement=document.createElement("a");
                        anchorElement.href="localhost:8080/users/login";
                        anchorElement.text="login";
                        outputDiv.appendChild(anchorElement);
                        outputDiv.innerHTML="Login Required";
                    }else{
                        console.log("Unknown status "+status);
                    }

                }
        }
        xhttp.open("GET","http://localhost:8080/users/getPendingFriendRequests",true);
        xhttp.setRequestHeader("Token",token);
        xhttp.send();
    }
    fetchPendingFriendRequests();        

    async function sendFriendRequest(){
            
        const toUsername=document.getElementById("sendFriendRequestInput").value;
            
        if( isEmpty(toUsername)){
                outputDiv.innerHTML="empty fields";
                return;
        }
        console.log("dasd"+toUsername);
            
            const xhttp=new XMLHttpRequest();

            xhttp.onreadystatechange=()=>{
                if(xhttp.readyState === 4){
                    const status=xhttp.status;
                    if(status === 200){
                        requestStatusDiv.innerHTML="Request sent";
                    }
                    if(status === 500){
                        requestStatusDiv.innerHTML="Server Error";
                    }else{
                        console.log("Unknown status: "+status);
                    }
                }
            }

            xhttp.open("POST","http://localhost:8080/users/sendFriendRequest",true);
            xhttp.setRequestHeader("Token",token);
            xhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
            xhttp.send(`ToUsername=${toUsername}`);
        }

        

    </script>
</html>